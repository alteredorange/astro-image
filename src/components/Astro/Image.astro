---
let { src, width, height, rotate, gif, style, alt, flip, flop } = Astro.props;

//put all props in an object
const allProps = { src, width, height, rotate, gif, style, alt, flip, flop };

//remove undefined props
Object.keys(allProps).forEach((key) =>
  allProps[key] === undefined ? delete allProps[key] : {}
);
Object.keys(allProps).forEach((key) =>
  allProps[key] == "" ? delete allProps[key] : {}
);

//construct srcUrl with defined props
let srcUrl = "/images/?";
Object.keys(allProps).forEach(
  (key) => (srcUrl += key + "=" + allProps[key] + "&")
);

//get rid of trailing &
srcUrl = srcUrl.slice(0, -1);

const acceptHeaders = Astro.request.headers.get("accept");
const w = Astro.request.headers.get("width");

//generate final link will all props that aren't "undefined"
const finalLink = `${src}?w=${w}&h=${height}&fit=crop&fm=${
  gif ? "gif" : "jpg"
}&flip=${flip ? "h" : "v"}&flop=${
  flop ? "h" : "v"
}&rotate=${rotate}&q=${style}&alt=${alt}`;

//get format in priority of avif, webp, jpg
const format =
  acceptHeaders == "*/*"
    ? "avif"
    : acceptHeaders.includes("image/avif")
    ? "avif"
    : acceptHeaders.includes("image/webp")
    ? "webp"
    : "jpg";
// const b = test == "*/*" ? "avif" : test.includes("image/avif") ? "avif" : test.includes("image/webp") ? "webp" : "jpg";
// console.log("FFFF", format)

if (style == "undefined") style = "";

const localImage = src.startsWith("/assets/");

// console.log("SRC here: ", src)

const newUrl =
  "/images/?src=" +
  src +
  "&width=" +
  width +
  "&rotate=" +
  rotate +
  "&format=" +
  format +
  "&gif=" +
  gif +
  "&flip=" +
  flip +
  "&flop=" +
  flop;

const blurUrl =
  "/images/?src=" +
  src +
  "&width=10" +
  "&format=" +
  format +
  "&blur=true" +
  "&gif=" +
  gif;

// console.log("newURL: ", newUrl)
// console.log("forma: " , forma);
// console.log(avif)

// const format = avif ? "avif" : webp ? "webp" : "jpg";

// console.log(format)
const finalW = (await width) ? width + "px" : "";
// console.log({finalW})
---

<head> </head>

<img class={style} width={finalW} height={height + "px"} src={srcUrl} alt={alt}
/>

<!-- <picture>


</picture> -->
